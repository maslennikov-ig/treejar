# ИИ-Ассистент по Продажам Treejar — Отчет о прогрессе

**Дата:** 25 февраля 2026 г.
**Версия:** 0.2.7+
**Репозиторий:** Приватный GitHub (`maslennikov-ig/treejar`)
**Статус:** Активная разработка — Завершена 2-я неделя из 13

---

## Краткий обзор

Разработка ИИ-ассистента по продажам для Treejar идет по графику. За первые 5 дней активной разработки (21-25 февраля) мы полностью подготовили фундамент проекта (1-я неделя) и завершили интеграцию с Zoho Inventory вместе с поисковым RAG-пайплайном (2-я неделя). Сейчас система может синхронизировать полный каталог товаров из Zoho Inventory EU и выполнять семантический поиск по продуктам с использованием мультиязычной модели эмбеддингов.

**Ключевые метрики:**

| Метрика | Значение |
|--------|-------|
| Файлы исходного кода | 58 модулей Python |
| Строки рабочего кода | 2 585 |
| Строки тестового кода | 1 309 |
| Автоматизированные тесты | 53 (синтетические тесты, успешно проходят) |
| Миграции базы данных | 2 |
| API эндпоинты | 25 |
| Модели базы данных | 6 |
| Протоколы интеграции | 4 |
| Файлы документации | 30+ |
| Git коммиты | 28 |
| Контроль качества кода | ruff + mypy strict + pytest (без ошибок) |

---

## 1. Архитектура и технологический стек

Система построена как production-grade Python бекенд со следующим стеком технологий, выбранным для оптимизации затрат и производительности на B2B-рынке стран Ближнего Востока:

| Уровень | Технология | Обоснование |
|-------|-----------|-----------|
| Веб-фреймворк | FastAPI (async) | Высокопроизводительное асинхронное API, автогенерация документации OpenAPI |
| База данных | PostgreSQL + pgvector (Supabase) | Реляционные данные + векторный поиск по сходству в одной БД |
| ORM | SQLAlchemy 2.0 (async) | Типобезопасная, современная Python ORM с полной поддержкой асинхронности |
| Миграции | Alembic | Миграции схемы БД с контролем версий |
| Векторные эмбеддинги | fastembed (BAAI/bge-m3) | Мультиязычная (EN/AR/RU), работает локально, нулевые затраты на API |
| LLM | DeepSeek V3.2 через OpenRouter | $0.27/млн токенов ввода, $1.10/млн токенов вывода — ожидаемо ~$20-40/мес |
| Кэш / Очередь | Redis + ARQ | Асинхронная очередь задач для фоновой синхронизации, кэширования токенов |
| WhatsApp шлюз | Wazzup24 API | Сертифицированный провайдер WhatsApp Business |
| CRM | Zoho CRM v7 (EU) | Существующая CRM-система клиента |
| Склад / Инвентарь | Zoho Inventory v1 (EU) | Существующая складская система клиента (856+ SKU) |
| Админ-панель | SQLAdmin | Встроенная веб-админка без фронтенд-кода |
| HTTP-клиент | httpx (async) | Современный асинхронный HTTP с пулом соединений |

### Диаграмма архитектуры

```
WhatsApp (Wazzup)                Zoho CRM EU
       |                              |
       v                              v
+----------------------------------------------+
|              FastAPI Приложение               |
|                                               |
|  Webhook  -->  LLM Движок   --> CRM Клиент    |
|     |            |    |                       |
|     v            v    v                       |
| Сообщения      Товары  База Знаний            |
|     |            |         |                  |
|     v            v         v                  |
|  PostgreSQL + pgvector (Supabase Cloud)       |
+----------------------------------------------+
       |                              |
       v                              v
  Redis + ARQ                  Zoho Inventory EU
(очередь задач)               (синхронизация товаров)
```

---

## 2. Что было сделано (1-я и 2-я недели)

### 2.1. Фундамент проекта (1-я неделя) — ЗАВЕРШЕНО

Весь скелет приложения был реализован в одном коммите, сформировав архитектуру для всей последующей работы:

**6 Моделей базы данных** с первичными ключами UUID, автоматическими метками времени и правильными ограничениями:

| Модель | Назначение | Ключевые поля |
|-------|---------|------------|
| `Product` | Каталог товаров из Zoho | SKU, названия (EN/AR), цена, остаток, векторный эмбеддинг (1024D) |
| `Conversation` | Ветки сообщений WhatsApp | Телефон, статус, язык, тональность, ссылка на сделку в CRM |
| `Message` | Отдельные сообщения в диалогах | Роль (user/assistant/system), содержимое, затраты токенов |
| `Escalation` | Отслеживание перевода на менеджера | Причина, приоритет, назначенный менеджер |
| `KnowledgeBase` | FAQ, правила, ценности компании | Источник, содержимое, векторный эмбеддинг (1024D), ограничение уникальности |
| `QualityReview` | Оценка качества ответов ИИ | Оценка (0-30), разбивка по критериям, заметки проверяющего |

**4 Протокола интеграции** (абстрактные интерфейсы), позволяющие менять провайдеров без изменения кода:

| Протокол | Назначение | Реализация |
|----------|---------|---------------|
| `InventoryProvider` | Операции с товарами и остатками | `ZohoInventoryClient` |
| `CRMProvider` | Управление контактами и сделками | (3-я неделя) |
| `MessagingProvider` | Отправка/прием WhatsApp | (3-я неделя) |
| `VectorStore` | Операции векторного поиска | `PgVectorStore` |

**25 REST API Эндпоинтов**, сгруппированных по доменам:

| Группа | Эндпоинты | Описание |
|-------|-----------|-------------|
| Products | `GET /`, `POST /search`, `POST /sync` | Каталог, семантический поиск, ручной запуск синхронизации |
| Conversations | `GET /`, `GET /:id`, `PATCH /:id` | Управление диалогами |
| Inventory | `GET /stock`, `GET /stock/:sku`, Расходные ордера | Остатки в реальном времени и заказы |
| CRM | CRUD Контактов, CRUD Сделок | Интеграция с Zoho CRM |
| Quality | CRUD Проверок (Reviews), Отчеты | Мониторинг качества ИИ |
| Admin | Метрики, Промпты, Настройки | API админ-панели |
| Webhook | `POST /wazzup` | Получатель вебхуков WhatsApp |
| Health | `GET /health` | Проверка работоспособности системы |

**Pydantic Схемы** для каждой модели с полной валидацией, включая:
- Обобщение для пагинированного ответа (`PaginatedResponse[T]`)
- Отдельные схемы для чтения/создания/обновления (Read/Create/Update) каждой модели
- Строгую валидацию полей (цена >= 0, лимит 1-50 и т.д.)

**Инфраструктура:**
- Система миграций Alembic с 2 версионированными миграциями
- Управление соединениями Redis с корректной их очисткой
- Фабрика асинхронных сессий БД с `expire_on_commit=False`
- Конфигурация через `.env` с обеспечением защиты production-секретов
- Продуманный `.gitignore` (секреты, PDF-файлы и CSV-данные не попадают в репозиторий)

---

### 2.2. Интеграция с Zoho Inventory (2-я неделя) — ЗАВЕРШЕНО

Connector (Коннектор) для Zoho Inventory уровня enterprise с высокой надежностью:

**`ZohoInventoryClient`** — Полноценный OAuth2 клиент (более 220 строк):
- Рефреш OAuth2 токена с распределенной блокировкой на базе Redis (предотвращает эффект «thundering herd» / шквал запросов)
- Автоматические повторные запросы (retry) с экспоненциальной задержкой (3 попытки: 2с, 4с)
- Обработка 401 (истекший токен) — удаляет токен из кэша, запрашивает новый и повторяет попытку
- Обработка 429 (лимит запросов) — экспоненциальная пауза
- Обработка сетевых ошибок и тайм-аутов — повтор с паузой
- Пул соединений через `httpx.AsyncClient` (один пул соединений на задачу)
- Безопасная очистка ресурсов через контекстный менеджер `async with` (даже при отмене задачи)
- Конкурентная проверка остатков с помощью `Semaphore(5)` для соблюдения лимитов API
- Корректная настройка всех EU URL (`zohoapis.eu`, `accounts.zoho.eu`)

**Синхронизация товаров (Job)** — фоновый ARQ воркер:
- Полная синхронизация каталога из Zoho Inventory (все страницы, по 200 позиций на страницу)
- Массовый upsert в PostgreSQL (`INSERT ... ON CONFLICT DO UPDATE`) — один SQL запрос на пакет
- Подсчет созданных и обновленных записей через `RETURNING xmax` (внутренний механизм PostgreSQL)
- Маппинг полей Zoho в нашу модель Product (SKU, название, цена, остаток, категория, картинка)
- Автоматическое обновление меток `synced_at` и `updated_at` при каждой синхронизации
- Ошибки пробрасываются в ARQ для автоматического перезапуска
- Запуск по cron-расписанию: каждые 6 часов (00:00, 06:00, 12:00, 18:00)
- Тайм-аут задачи: 10 минут (хватает для каталогов 856+ SKU)

---

### 2.3. RAG Пайплайн — Семантический поиск по товарам (2-я неделя) — ЗАВЕРШЕНО

Основной интеллектуальный слой, позволяющий ИИ-ассистенту находить товары по запросу на естественном языке:

**`EmbeddingEngine`** — Сервис-одиночка (Singleton) для расчета эмбеддингов:
- Загружает модель BAAI/bge-m3 (мультиязычную: Английский + Арабский + Русский)
- 1024-мерные вектора для качественного семантического сопоставления
- Потокобезопасная отложенная загрузка (lazy loading) с двойной блокировкой проверки (`threading.Lock`)
- Неблокирующие асинхронные методы (`embed_async`, `embed_batch_async`) через `asyncio.to_thread`
- Пакетная обработка (по 32 элемента) для предотвращения скачков памяти на больших каталогах
- Нулевые затраты на API — модель запускается локально через ONNX runtime

**`PgVectorStore`** — Векторный поиск в PostgreSQL:
- Гибридный поиск: векторное сходство + SQL фильтры (категория, ценовой диапазон, наличие на складе)
- Использует оператор косинусного расстояния `<=>` в pgvector для поиска ближайших соседей
- Отфильтровывает товары без эмбеддингов
- Поддерживает как поиск товаров, так и поиск по базе знаний

**Индексатор базы знаний** — Автоматизированный импорт документов:
- Парсинг FAQ (20 вопросов/ответов), правил продаж (17 двуязычных правил), ценностей компании (14 ценностей)
- Сохранение двуязычного контента (Русский + Английский)
- Защита от пустого контента (пропускает чанки без смыслового текста)
- Защитное логирование (defensive logging) при формировании 0 чанков парсером
- Относительные пути через `__file__` (корректно работает в Docker/ARQ воркерах)
- Upsert с ограничением уникальности `(source, title)` — безопасно для повторных запусков

---

### 2.4. Качество кода и Тестирование

Каждый коммит проходит обязательную тройную проверку качества:

| Проверка | Инструмент | Конфигурация |
|-------|------|--------------|
| Линтинг | ruff | Включены правила E, W, F, I, UP, B, SIM, TCH |
| Проверка типов | mypy | `strict = true` с плагином Pydantic |
| Тесты | pytest | 53 синтетических теста, полная изоляция Ввода/Вывода (всё замокано) |

> [!NOTE]
> **Важно:** В данный момент реализовано **53 синтетических теста**, которые проверяют логику работы модулей в строгой изоляции (unit-тесты с замокированными внешними вызовами: API Zoho, БД). Полноценное E2E (End-to-End) тестирование на реальных данных и с реальными интеграциями запланировано на финальный этап разработки перед передачей проекта (на 6-й неделе).

**Покрытие тестами по компонентам:**

| Компонент | Тестов | Что проверяется |
|-----------|-------|----------------|
| Zoho OAuth & Token Lock | 4 | Кэшированный токен, тайм-аут блокировки, появление во время ожидания, полный рефреш |
| Zoho HTTP Retry (401) | 2 | Рефреш токена при 401, проброс ошибки при исчерпании попыток |
| Zoho HTTP Retry (429) | 2 | Тайминги экспоненциальной задержки (2с, 4с), исчерпание попыток |
| Zoho Sync Job | 2 | Полный цикл синхронизации, обработка ответа API |
| EmbeddingEngine | 3 | Паттерн Singleton, одиночный эмбеддинг, пакетный эмбеддинг |
| Embedding Async | 6 | Подсчет коммитов на пакет, форматирование текста, обработка None |
| Singleton Isolation | 4 | Идентичность объектов, сброс (reset), патчинг на уровне класса, ленивая загрузка |
| RAG Product Search | 1 | Гибридный поиск с фильтрами + векторное ранжирование |
| RAG Knowledge Search | 1 | Извлечение данных из базы знаний с эмбеддингами |
| Markdown Parsers | 25 | Парсинг FAQ, правил продаж, ценностей (пустые/валидные/пограничные случаи) |
| Health Endpoint | 1 | Проверка API ответа `HealthCheckResponse` |
| Index Documents | 2 | Отсутствующая директория docs, откат (rollback) при ошибке БД |

**Принятые меры безопасности:**
- Защита production-секретов (остановка при старте, если в production используются пароли по умолчанию)
- Полное отсутствие захардкоженных учетных данных в исходном коде
- Конфиденциальные файлы удалены из истории git
- OAuth токен хранится в Redis с TTL (автоматическое истечение срока)
- Распределенная блокировка Redis исключает гонку потоков при обновлении токена
- Валидация входных данных на всех API эндпоинтах (Pydantic + ограничения Field)

---

## 3. Подготовленная документация

Помимо кода была подготовлена исчерпывающая документация:

| Документ | Содержимое |
|----------|----------|
| Техническое задание (tz.md) | Полные требования к проекту |
| Расширенное ТЗ (tz-extended.md) | Детальные технические требования |
| Требования к ИИ-агенту | Правила поведения, личность, логика перевода на менеджера |
| Принципы диалогов в продажах | 17 правил с двуязычными примерами |
| Ценности компании | 14 ключевых ценностей для поведения ИИ |
| Чек-лист оценки диалога | 15-балльная система проверки качества |
| Спецификация базы знаний | Спецификация RAG-пайплайна |
| FAQ | 20 пар вопросов-ответов для базы знаний |
| Метрики | 17 KPI для измерения производительности бота |
| Анализ архитектуры | Глубокий анализ 3-х вариантов архитектуры |
| Исследование технологий | Комплексное сравнение LLM и фреймворков |
| Отчет проверки (Code Review) | Подробный разбор на 740 строк (найдено и исправлено 24 ошибки) |
| Примеры диалогов | 13 классифицированных реальных диалогов с разбором |
| Примеры КП (Quotations) | Анализ 4 структур коммерческих предложений из PDF |
| План действий с клиентом | Отслеживание всех полученных материалов |

---

## 4. Полученные и внедренные материалы клиента

| # | Материал | Статус | Куда внедрено |
|---|----------|--------|-----------------|
| 1 | API-ключи Zoho CRM | Получено | `.env` конфигурация |
| 2 | API-ключи Zoho Inventory + Org ID | Получено | `.env` + ZohoInventoryClient |
| 3 | API-ключ Wazzup | Получено | `.env` конфигурация |
| 4 | Учетные данные Bazara.ae API | Получено | `.env` (4-я неделя) |
| 5 | Правила ведения продаж (17 правил, RU+EN) | Получено | Индексатор базы знаний |
| 6 | Ценности компании (14 приоритетов) | Получено | Индексатор базы знаний |
| 7 | FAQ (20 пар В/О) | Получено | Индексатор базы знаний |
| 8 | Чек-лист оценки качества | Получено | Модель QualityReview |
| 9 | Метрики (17 KPI) | Получено | docs/metrics.md |
| 10 | Статистика за 20 месяцев | Получено | Архитектурные решения |
| 11 | 59 скриншотов диалогов | Получено | Анализ тренировочных данных |
| 12 | 4 примера КП в PDF | Получено | Спецификация структуры КП |
| 13 | Ответы на чек-лист (20 вопросов) | Получено | docs/checklist-answers.md |
| 14 | Контакты отдела продаж (7 менеджеров) | Получено | Маршрутизация при эскалации |

---

## 5. Стратегия LLM: DeepSeek V3.2

После тщательного анализа мы выбрали DeepSeek V3.2 (через OpenRouter) в качестве основной LLM:

| Параметр | DeepSeek V3.2 | Claude 3.5 Sonnet (альтернатива для генерации) |
|-----------|---------------|---------------------------|
| Стоимость ввода | $0.27/млн токенов | $3.00/млн токенов |
| Стоимость вывода | $1.10/млн токенов | $15.00/млн токенов |
| Контекстное окно | 128K токенов | 200K токенов |
| Ожидаемая стоимость (месяц) | **$20-40** | **$200-400** |
| Языки | Отличные EN/AR/RU | Отличные EN/AR/RU |
| Качество диалогов продаж | Очень высокое | Выдающееся |

Разница в стоимости в 10-15 раз существенна для B2B-оператора, обрабатывающего сотни диалогов ежедневно. Изначально мы предполагали использовать гибридную схему (дешевый Haiku для классификации намерений + дорогой Sonnet для генерации ответа). Переход на DeepSeek V3.2 обеспечивает превосходное качество (уровня флагманского Sonnet) за малую долю стоимости конкурентов, позволяя отказаться от сложной связки из двух моделей в пользу одной мощной и дешевой. При необходимости, модель можно заменить на любую другую, совместимую с OpenRouter, просто изменив одну переменную окружения.

---

## 6. Дорожная карта и дальнейшие шаги

| Неделя | Объем работы | Статус |
|------|-------|--------|
| **Неделя 1** | Каркас проекта: модели, схемы, заглушки API, конфигурация, миграции | **ВЫПОЛНЕНО** |
| **Неделя 2** | Интеграция с Zoho Inventory + RAG пайплайн + эмбеддинги + тесты | **ВЫПОЛНЕНО** |
| **Неделя 3** | Webhook WhatsApp (Wazzup) + коннектор к Zoho CRM + LLM движок | Следующий этап |
| **Неделя 4** | Интеграция остатков, CRM и RAG + тестовые диалоги | В планах |
| **Неделя 5** | Полный пайплайн генерации SaleOrder из диалога | В планах |
| **Неделя 6** | Индивидуальные цены + Сценарий эскалации на менеджера | В планах |
| **Неделя 7** | Базовая админ-панель (просмотр диалогов, настройки промптов) | В планах |
| **Неделя 8** | Деплой на VPS (MVP Этапа 1) + Сдача Этапа 1 | В планах |
| **Неделя 9-10** | Автоматизированный Бот контроля качества (QA) диалогов ИИ | В планах |
| **Неделя 11** | Оценка диалогов + Еженедельные отчеты и алерты в Telegram | В планах |
| **Неделя 12** | Рекомендательная система + Реферальная программа | В планах |
| **Неделя 13** | Комплексное E2E тестирование, нагрузочное тестирование, ПНР, передача | В планах |

**Ближайшие шаги (3-я неделя):**
1. Приемник вебхуков Wazzup — получать сообщения из WhatsApp
2. Движок LLM DeepSeek V3.2 — обрабатывать сообщения с контекстом
3. Коннектор к Zoho CRM — создавать контакты и сделки
4. Менеджер диалогов — поддерживать состояние диалога (память)
5. Пайплайн ответов — RAG контекст + генерация LLM + проверка качества

---

## 7. Статистика репозитория

```
Язык:             Python 3.12
Фреймворк:        FastAPI + SQLAlchemy 2.0 (async)
Исходные файлы:   58 модулей
Файлы тестов:     7 модулей тестов
Рабочий код:      2 585 строк
Тестовый код:     1 309 строк
Код миграций:     283 строки
Всего:            4 177 строк
Тесты:            53 (все проходят успешно)
Контроль качества:ruff (линтер) + mypy strict (типы) + pytest (тесты)
Статус CI:        Всё зелено
Git коммиты:      28
Версия:           0.2.7
```

---

*Отчет сгенерирован 25 февраля 2026 г.*
*Noor AI Sales Assistant — Мебель для офиса Treejar (Дубай, ОАЭ).*
